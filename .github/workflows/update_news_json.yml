name: Update news_recent.json

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

jobs:
  build-news-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser

      - name: Build news_recent.json
        run: |
          python S33R/scripts/build_news_json.py

      - name: Commit changes via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: dev  # troque para "main" se quiser commitar na main
        run: |
          set -e

          BRANCH="${TARGET_BRANCH:-main}"
          REPO="${GITHUB_REPOSITORY}"

          # Lista arquivos modificados dentro de S33R/data
          CHANGED=$(git ls-files -m S33R/data/* || true)

          if [ -z "$CHANGED" ]; then
            echo "No changes detected."
            exit 0
          fi

          for file in $CHANGED; do
            echo "Processing $file"

            # Conteúdo em base64 (uma linha só)
            CONTENT_B64=$(base64 -w0 "$file")

            API_URL="https://api.github.com/repos/$REPO/contents/$file"

            # Recupera SHA atual (se existir) na branch alvo
            SHA=$(curl -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              "$API_URL?ref=$BRANCH" | jq -r '.sha // empty')

            if [ -z "$SHA" ] || [ "$SHA" = "null" ]; then
              MSG="Add $file"
              cat > body.json <<EOF
            {
              "message": "$MSG",
              "content": "$CONTENT_B64",
              "branch": "$BRANCH"
            }
            EOF
            else
              MSG="Update $file"
              cat > body.json <<EOF
            {
              "message": "$MSG",
              "content": "$CONTENT_B64",
              "branch": "$BRANCH",
              "sha": "$SHA"
            }
            EOF
            fi

            # Faz o PUT na API com o body em arquivo (evita argumento gigante)
            curl -s -X PUT \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              --data-binary @body.json \
              "$API_URL"

            echo "Done $file"
          done
